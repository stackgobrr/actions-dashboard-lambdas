name: Build and Publish Lambdas

on:
  push:
    branches: [main]
    paths:
      - 'lambdas/**'
  workflow_dispatch:

jobs:
  build-lambdas:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        function: [oauth-start, oauth-callback]
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'lambdas/${{ matrix.function }}/package-lock.json'
      
      - name: Install dependencies
        working-directory: lambdas/${{ matrix.function }}
        run: npm ci
      
      - name: Run tests
        working-directory: lambdas/${{ matrix.function }}
        run: npm test
      
      - name: Package Lambda
        working-directory: lambdas/${{ matrix.function }}
        run: |
          zip -r lambda-${{ matrix.function }}-${{ github.sha }}.zip \
            index.js package.json package-lock.json node_modules/
      
      - name: Upload to S3
        run: |
          aws s3 cp \
            lambdas/${{ matrix.function }}/lambda-${{ matrix.function }}-${{ github.sha }}.zip \
            s3://${{ vars.LAMBDA_S3_BUCKET_NAME }}/lambda-${{ matrix.function }}-${{ github.sha }}.zip
      
      - name: Upload artifact for manifest
        uses: actions/upload-artifact@v6
        with:
          name: lambda-${{ matrix.function }}-metadata
          path: |
            lambdas/${{ matrix.function }}/package.json
          retention-days: 1

  generate-manifest:
    needs: build-lambdas
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate manifest
        # Dynamically find lambda function names from lambdas/ subdirectories 
        run: |
          LAMBDAS=$(for fn in $(ls -d lambdas/*/ | xargs -n1 basename); do
            echo "\"$fn\": {\"package\": \"s3://${{ vars.LAMBDA_S3_BUCKET_NAME }}/lambda-${fn}-${{ github.sha }}.zip\", \"sha\": \"${{ github.sha }}\"}"
          done | paste -sd,)

          cat > manifest.json <<EOF
          {
            "commit_sha": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "lambdas": { $LAMBDAS }
          }
          EOF
          cat manifest.json
      
      - name: Upload manifest to S3
        run: |
          aws s3 cp manifest.json \
            s3://${{ vars.LAMBDA_S3_BUCKET_NAME }}/manifests/lambda-manifest.json
      
      - name: Trigger main repository deployment
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.MAIN_REPO_TRIGGER_TOKEN }}" \
            https://api.github.com/repos/${{ vars.MAIN_REPO }}/dispatches \
            -d '{"event_type":"lambda-updated","client_payload":{"sha":"${{ github.sha }}"}}'